apiVersion: "nuclio.io/v1"
kind: Function
metadata: 
  name: mqtt-msgdispatcher
  namespace: nuclio
spec:
  handler: "main:handler"
  description: "Function that receives data from sensors of incoming planes and dispathces messages on other topics"
  runtime: nodejs
  image: "nuclio/mqtt-message-dispatcher:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      kind: "mqtt"
      url: "user:password@192.168.1.7:1883"
      attributes:
        subscriptions:
        - topic: iot/planes/arrivals
          qos: 0
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7Ci8vbnBtIHBhY2thZ2UgdG8gbWFuYWdlIGFpcnBsYW5lcwp2YXIgUGxhbmUgPSByZXF1aXJlKCdwbGFuZXMtZ2VuZXJhdG9yJyk7Ci8vbnBtIHBhY2thZ2UgdG8gbWFuYWdlIElGVFRUIGludm9jYXRpb24KdmFyIElGVFRUID0gcmVxdWlyZSgnaWZ0dHQtd2ViaG9va3MtY2hhbm5lbCcpOwpjb25zdCBpZnR0dCA9IG5ldyBJRlRUVCgnbkFtSUw3VzQ1T2VFYllyRjhPMEx5dFlhdXA3WWRVNVJFZ1JuS1l0TmRVcCcpOwoKdmFyIG1xdHQgPSByZXF1aXJlKCdtcXR0JyksIHVybCA9IHJlcXVpcmUoJ3VybCcpOwp2YXIgbXF0dF91cmwgPSB1cmwucGFyc2UocHJvY2Vzcy5lbnYuQ0xPVURBTVFQX01RVFRfVVJMIHx8ICdtcXR0Oi8vZ3Vlc3Q6Z3Vlc3RAMTkyLjE2OC4xLjc6MTg4MycpOwp2YXIgYXV0aCA9IChtcXR0X3VybC5hdXRoIHx8ICc6Jykuc3BsaXQoJzonKTsKdmFyIHVybCA9ICJtcXR0Oi8vIiArIG1xdHRfdXJsLmhvc3Q7Cgp2YXIgb3B0aW9ucyA9IHsKICAgIHBvcnQ6IG1xdHRfdXJsLnBvcnQsCiAgICBjbGllbnRJZDogJ21xdHRqc18nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyKDIsIDgpLAogICAgdXNlcm5hbWU6IGF1dGhbMF0sCiAgICBwYXNzd29yZDogYXV0aFsxXSwKfTsKCi8vVGhpcyBmdW5jdGlvbiBzZW5kcyBtZXNzYWdlcyB0byB0aGUgZ2VuZXJhbExvZ2dlciBvbiB0aGUgdG9waWMgbG9ncy9hcnJpdmFscwpmdW5jdGlvbiBzZW5kX2ZlZWRiYWNrT25HZW5lcmFsKG1zZykgewogICAgdmFyIHEgPSAnbG9ncy9hcnJpdmFscyc7CiAgICBhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxOTIuMTY4LjEuNzo1NjcyJykudGhlbihmdW5jdGlvbihjb25uKSB7CiAgICAgICAgcmV0dXJuIGNvbm4uY3JlYXRlQ2hhbm5lbCgpLnRoZW4oZnVuY3Rpb24oY2gpIHsKICAgICAgICAgICAgdmFyIG9rID0gY2guYXNzZXJ0UXVldWUocSwge2R1cmFibGU6IGZhbHNlfSk7CiAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsKICAgICAgICAgICAgICAgIGNoLnNlbmRUb1F1ZXVlKHEsIEJ1ZmZlci5mcm9tKG1zZykpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIiBbeF0gU2VudCAnJXMiLCBtc2cpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoLmNsb3NlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbm4uY2xvc2UoKTsKICAgICAgICB9KTsKICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7Cn0KCi8vIFRoaXMgZnVuY3Rpb24gdGFrZXMgY2FyZSBvZiBtYW5hZ2luZyB0aGUgZXZlbnRzIGdlbmVyYXRlZCBieSBwbGFuZVByb2R1Y2VyCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7CiAgICB2YXIgX2V2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOwogICAgLy8gcmVjcmVhdGUgdGhlIHBsYW5lIHJlY2VpdmVkIGFzIGV2ZW50CiAgICB2YXIgY3VycmVudFBsYW5lID0gbmV3IFBsYW5lKF9ldmVudC5ib2R5LmRhdGEpOwoKICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrIik7CgogICAgLy8gSXQgc2VuZHMgdGhlIGN1cnJlbnRQbGFuZSBpbmZvcm1hdGlvbiB0byB0aGUgZ2VuZXJhbCBsb2dnZXIsCiAgICAvLyBpdCBpcyB0aGUgY3VycmVudCBwbGFuZSB0aGF0IGlzIGFwcHJvYWNoaW5nIHRvIGFpcnBvcnQKICAgIHNlbmRfZmVlZGJhY2tPbkdlbmVyYWwoIklOQ09NSU5HIC0tLS0tPiAiICsgY3VycmVudFBsYW5lLm1vZGVsICsgIiAiICsgY3VycmVudFBsYW5lLm5hbWUgKyAiICIgKyBjdXJyZW50UGxhbmUuZnVlbExldmVsICsgIiAiICsgY3VycmVudFBsYW5lLnRhZyk7CgogICAgLy8gaWYgdGhlIGN1cnJlbnRQbGFuZSBpcyBsYW5kZWQuLgogICAgaWYgKGN1cnJlbnRQbGFuZS50YWcgPT0gJ19MQU5ERURfJykgewogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoKTsgICAgICAgIAoKICAgICAgICAvLyBpbnZva2UgdGhlIHdlYmhvb2sKICAgICAgICBpZnR0dC5wb3N0KCdwbGFuZV9sYW5kZWQnLCBbY3VycmVudFBsYW5lLm1vZGVsICsgIiAtICIgKyBjdXJyZW50UGxhbmUubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGUuZ2V0RGF0ZSgpICsgIi8iICsgKGRhdGUuZ2V0TW9udGgoKSsxKSArICIvIiArIGRhdGUuZ2V0RnVsbFllYXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZGF0ZS5nZXRIb3VycygpKzEpICsgIjoiICsgZGF0ZS5nZXRNaW51dGVzKCldKTsKCiAgICAgICAgdmFyIGNsaWVudCA9IG1xdHQuY29ubmVjdCh1cmwsIG9wdGlvbnMpOyAgIAogICAgCiAgICAgICAgLy8gZm9yd2FyZCB0aGUgY3VycmVudCBwbGFuZSBpbmZvcm1hdGlvbnMgb24gdGhlIG90aGVycyBtcXR0IHRvcGljcwogICAgICAgIGNsaWVudC5vbignY29ubmVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjbGllbnQucHVibGlzaCgnaW90L3BsYW5lcy9hcnJpdmFscy9mdWVsJywgY3VycmVudFBsYW5lLnRvU3RyaW5nKCksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjaygnTVFUVCBNZXNzYWdlIHNlbnQgdG8gZnVlbCBhZGRpY3RzJyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2xpZW50LnB1Ymxpc2goJ2lvdC9wbGFuZXMvYXJyaXZhbHMvdGlyZXMnLCBjdXJyZW50UGxhbmUudG9TdHJpbmcoKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKCdNUVRUIE1lc3NhZ2Ugc2VudCB0byB0aXJlcyBhZGRpY3RzJyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2xpZW50LnB1Ymxpc2goJ2lvdC9wbGFuZXMvYXJyaXZhbHMvaXNzdWVzJywgY3VycmVudFBsYW5lLnRvU3RyaW5nKCksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjaygnTVFUVCBNZXNzYWdlIHNlbnQgdG8gZ2VuZXJhbCBhZGRpY3RzJyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2xpZW50LmVuZCgpOwogICAgICAgIH0pOwogICAgfQp9
    commands:
      - 'npm install amqplib'
      - 'npm install mqtt'
      - 'npm i planes-generator'
      - 'npm i ifttt-webhooks-channel'
    codeEntryType: sourceCode
  platform: {} 